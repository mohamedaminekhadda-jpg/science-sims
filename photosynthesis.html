<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photosynthesis ‚Äî Interactive Simulation</title>
  <style>
    :root{
      --bg:#0b0d12; --panel:#121621; --text:#e9eefc; --muted:#9aa7c2; --stroke:rgba(255,255,255,.10);
      --good:#5ef0a3; --warn:#ffcc66; --bad:#ff6b6b; --accent:#7aaaff;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font:14px system-ui,Segoe UI,Roboto,Arial;}
    .wrap{display:grid; grid-template-columns: 380px 1fr; gap:14px; padding:14px; box-sizing:border-box; min-height:820px;}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr; min-height:940px;} }
    .card{background:rgba(18,22,33,.92); border:1px solid var(--stroke); border-radius:16px; padding:12px;}
    h1{font-size:16px; margin:0 0 6px;}
    .muted{color:var(--muted);}
    label{display:block; margin:10px 0 6px;}
    input[type="range"]{width:100%;}
    select{width:100%; background:#0f1422; color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px;}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
    button{background:#1b2233; color:var(--text); border:1px solid rgba(255,255,255,.12); padding:8px 10px; border-radius:12px; cursor:pointer;}
    button:hover{filter:brightness(1.07)}
    .hud{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px;}
    .stat{padding:10px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06);}
    .big{font-size:16px; font-weight:700}
    .pill{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.05)}
    .callout{margin-top:10px; padding:10px; border-radius:14px; border:1px solid rgba(122,170,255,.25);
      background:linear-gradient(180deg, rgba(122,170,255,.10), rgba(122,170,255,.04)); line-height:1.45;}
    canvas{width:100%; height:100%; display:block; border-radius:16px; background:radial-gradient(1200px 650px at 30% 20%, rgba(97,141,255,.14), transparent 60%); border:1px solid var(--stroke);}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); overflow:hidden;}
    .bar > div{height:100%; width:0%;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Photosynthesis <span class="pill">Interactive</span></h1>
    <div class="muted">
      Explore how plants turn <b>CO‚ÇÇ + water + light</b> into <b>sugar</b> and release <b>oxygen</b>.
      Find the <b>limiting factor</b>.
    </div>

    <label>Scenario</label>
    <select id="scenario">
      <option value="normal" selected>Normal day (balanced)</option>
      <option value="shade">Shade (low light)</option>
      <option value="drought">Drought (low water)</option>
      <option value="co2low">Low CO‚ÇÇ (poor ventilation)</option>
      <option value="hot">Hot day (heat stress)</option>
    </select>

    <label>Light intensity ‚òÄÔ∏è <span id="lightVal" class="muted"></span></label>
    <input id="light" type="range" min="0" max="100" value="65"/>

    <label>CO‚ÇÇ level üå´Ô∏è <span id="co2Val" class="muted"></span></label>
    <input id="co2" type="range" min="0" max="100" value="60"/>

    <label>Water available üíß <span id="waterVal" class="muted"></span></label>
    <input id="water" type="range" min="0" max="100" value="70"/>

    <label>Temperature üå°Ô∏è <span id="tempVal" class="muted"></span></label>
    <input id="temp" type="range" min="0" max="45" value="25"/>

    <label>Stomata opening üçÉ <span id="stomataVal" class="muted"></span></label>
    <input id="stomata" type="range" min="0" max="100" value="60"/>

    <div class="row">
      <button id="presetMax">Max photosynthesis</button>
      <button id="presetSafe">Safe & balanced</button>
      <button id="reset">Reset</button>
    </div>

    <div class="hud">
      <div class="stat">
        <div class="muted">Photosynthesis rate</div>
        <div id="rate" class="big">‚Äî</div>
        <div class="bar" style="margin-top:8px;"><div id="rateBar"></div></div>
      </div>
      <div class="stat">
        <div class="muted">Limiting factor</div>
        <div id="limit" class="big">‚Äî</div>
        <div class="muted" id="limitExplain" style="margin-top:6px;"></div>
      </div>
      <div class="stat">
        <div class="muted">O‚ÇÇ produced</div>
        <div id="o2" class="big">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">Sugar made</div>
        <div id="sugar" class="big">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">Water loss</div>
        <div id="loss" class="big">‚Äî</div>
      </div>
      <div class="stat">
        <div class="muted">Plant stress</div>
        <div id="stress" class="big">‚Äî</div>
      </div>
    </div>

    <div class="callout">
      <div style="font-weight:700; margin-bottom:6px;">What you should notice</div>
      <div class="muted" id="lessonText"></div>
    </div>
  </div>

  <div class="card" style="padding:12px;">
    <canvas id="c"></canvas>
  </div>
</div>

<script>
(() => {
  const ui = {
    scenario: document.getElementById('scenario'),
    light: document.getElementById('light'),
    co2: document.getElementById('co2'),
    water: document.getElementById('water'),
    temp: document.getElementById('temp'),
    stomata: document.getElementById('stomata'),
    lightVal: document.getElementById('lightVal'),
    co2Val: document.getElementById('co2Val'),
    waterVal: document.getElementById('waterVal'),
    tempVal: document.getElementById('tempVal'),
    stomataVal: document.getElementById('stomataVal'),
    rate: document.getElementById('rate'),
    limit: document.getElementById('limit'),
    limitExplain: document.getElementById('limitExplain'),
    o2: document.getElementById('o2'),
    sugar: document.getElementById('sugar'),
    loss: document.getElementById('loss'),
    stress: document.getElementById('stress'),
    lessonText: document.getElementById('lessonText'),
    rateBar: document.getElementById('rateBar'),
    presetMax: document.getElementById('presetMax'),
    presetSafe: document.getElementById('presetSafe'),
    reset: document.getElementById('reset'),
  };

  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = canvas.getBoundingClientRect();
    canvas.width = Math.floor(r.width * dpr);
    canvas.height = Math.floor(r.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  // --- Model ---
  function tempEfficiency(T){
    const x = (T - 25) / 10;
    const e = Math.exp(-(x*x));
    const damage = T > 38 ? clamp(1 - (T-38)/7, 0, 1) : 1;
    return e * damage;
  }

  function compute(){
    const L = +ui.light.value/100;
    const C = +ui.co2.value/100;
    const W = +ui.water.value/100;
    const T = +ui.temp.value; // 0..45
    const S = +ui.stomata.value/100;

    const co2Intake = C * (0.25 + 0.75*S);
    const waterAvailableForProcess = W * (0.35 + 0.65*(1 - (S*0.35)));
    const tempEff = tempEfficiency(T);

    const fLight = L;
    const fCO2   = co2Intake;
    const fWater = waterAvailableForProcess;
    const fTemp  = tempEff;

    const factors = [
      {k:"Light", v:fLight, why:"Not enough light ‚Üí not enough energy captured."},
      {k:"CO‚ÇÇ",   v:fCO2,   why:"Not enough CO‚ÇÇ ‚Üí less carbon to build sugar."},
      {k:"Water", v:fWater, why:"Not enough water ‚Üí plant limits reactions and closes stomata."},
      {k:"Temp",  v:fTemp,  why:"Too cold/too hot ‚Üí enzymes slow down (too hot can damage)."},
    ].sort((a,b)=>a.v-b.v);

    const limiting = factors[0];
    let rate = clamp(limiting.v, 0, 1);
    const avg = (fLight + fCO2 + fWater + fTemp)/4;
    rate = clamp(rate * (0.75 + 0.25*avg), 0, 1);

    const transp = clamp((0.15 + 0.85*S) * (0.35 + 0.65*(T/45)) * (0.35 + 0.65*L), 0, 1);

    const heatStress = clamp((T-32)/13, 0, 1);
    const droughtStress = clamp((0.6 - W) / 0.6, 0, 1);
    const stress = clamp(Math.max(heatStress * (0.5+0.5*S), droughtStress, (1-fTemp)*0.7), 0, 1);

    const sugar = rate * 10;
    const o2 = rate * 8;

    return {L,C,W,T,S, rate, sugar, o2, transp, stress, limiting, fLight, fCO2, fWater, fTemp};
  }

  function setScenario(v){
    if (v==="normal"){ ui.light.value=65; ui.co2.value=60; ui.water.value=70; ui.temp.value=25; ui.stomata.value=60; }
    if (v==="shade"){ ui.light.value=20; ui.co2.value=60; ui.water.value=70; ui.temp.value=25; ui.stomata.value=65; }
    if (v==="drought"){ ui.light.value=70; ui.co2.value=60; ui.water.value=20; ui.temp.value=30; ui.stomata.value=25; }
    if (v==="co2low"){ ui.light.value=70; ui.co2.value=20; ui.water.value=70; ui.temp.value=25; ui.stomata.value=80; }
    if (v==="hot"){ ui.light.value=75; ui.co2.value=60; ui.water.value=45; ui.temp.value=40; ui.stomata.value=35; }
  }

  ui.scenario.onchange = (e)=>setScenario(e.target.value);
  ui.presetMax.onclick = ()=>{ ui.light.value=90; ui.co2.value=90; ui.water.value=90; ui.temp.value=25; ui.stomata.value=85; };
  ui.presetSafe.onclick= ()=>{ ui.light.value=70; ui.co2.value=60; ui.water.value=70; ui.temp.value=25; ui.stomata.value=55; };
  ui.reset.onclick = ()=>{ ui.scenario.value="normal"; setScenario("normal"); };

  // --- Animated particles ---
  const P = []; // particles
  function rand(a,b){ return a + Math.random()*(b-a); }

  function spawn(type, x,y, vx,vy, life, size){
    P.push({type, x,y, vx,vy, life, maxLife:life, size, rot:rand(0,Math.PI*2), spin:rand(-2,2)});
  }

  // --- Draw helpers ---
  function arrow(x1,y1,x2,y2, alpha){
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = "rgba(233,238,252,0.35)";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    const ang = Math.atan2(y2-y1, x2-x1);
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - Math.cos(ang-0.45)*10, y2 - Math.sin(ang-0.45)*10);
    ctx.lineTo(x2 - Math.cos(ang+0.45)*10, y2 - Math.sin(ang+0.45)*10);
    ctx.closePath();
    ctx.fillStyle = "rgba(233,238,252,0.35)";
    ctx.fill();
    ctx.restore();
  }

  // Scene anchors (computed each frame)
  function anchors(Wc,Hc){
    const sun = {x:Wc*0.18, y:Hc*0.22};
    const leaf = {x:Wc*0.58, y:Hc*0.54, w:320, h:220, rot:-0.2};
    const co2In = {x:Wc*0.16, y:Hc*0.58};
    const waterIn = {x:Wc*0.22, y:Hc*0.82};
    const o2Out = {x:Wc*0.90, y:Hc*0.40};
    const sugarOut = {x:Wc*0.88, y:Hc*0.68};
    const stomata = {x:leaf.x, y:leaf.y + leaf.h*0.34};
    // chloroplast zones inside leaf
    const chlA = {x:leaf.x-60, y:leaf.y-30};
    const chlB = {x:leaf.x+50, y:leaf.y+20};
    const calvin = {x:leaf.x+10, y:leaf.y-10}; // center
    return {sun, leaf, co2In, waterIn, o2Out, sugarOut, stomata, chlA, chlB, calvin};
  }

  function drawParticles(){
    for (const p of P){
      const a = clamp(p.life/p.maxLife, 0, 1);
      ctx.save();
      ctx.globalAlpha = Math.min(1, a*1.2);
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot);

      if (p.type==="photon"){
        ctx.fillStyle = "rgba(255,215,120,0.85)";
        ctx.beginPath();
        ctx.roundRect(-p.size, -p.size*0.35, p.size*2, p.size*0.7, 999);
        ctx.fill();
      }
      if (p.type==="co2"){
        ctx.fillStyle = "rgba(233,238,252,0.75)";
        ctx.beginPath(); ctx.arc(0,0,p.size,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha *= 0.8;
        ctx.fillStyle = "rgba(122,170,255,0.55)";
        ctx.beginPath(); ctx.arc(p.size*1.2, p.size*0.2, p.size*0.55, 0, Math.PI*2); ctx.fill();
      }
      if (p.type==="water"){
        ctx.fillStyle = "rgba(90,170,255,0.75)";
        ctx.beginPath();
        ctx.moveTo(0,-p.size);
        ctx.quadraticCurveTo(p.size, 0, 0, p.size*1.25);
        ctx.quadraticCurveTo(-p.size,0,0,-p.size);
        ctx.fill();
      }
      if (p.type==="energy"){
        // simplified ATP/NADPH "energy packet"
        ctx.fillStyle = "rgba(255,204,102,0.85)";
        ctx.beginPath();
        ctx.roundRect(-p.size*0.9, -p.size*0.6, p.size*1.8, p.size*1.2, 8);
        ctx.fill();
        ctx.globalAlpha *= 0.9;
        ctx.fillStyle = "rgba(0,0,0,0.22)";
        ctx.font = `${Math.max(10, p.size*0.9)}px system-ui`;
        ctx.fillText("‚ö°", -p.size*0.55, p.size*0.45);
      }
      if (p.type==="o2"){
        ctx.fillStyle = "rgba(233,238,252,0.70)";
        ctx.beginPath(); ctx.arc(0,0,p.size,0,Math.PI*2); ctx.fill();
        ctx.globalAlpha *= 0.55;
        ctx.strokeStyle = "rgba(180,220,255,0.55)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(0,0,p.size*0.75,0,Math.PI*2); ctx.stroke();
      }
      if (p.type==="sugar"){
        ctx.fillStyle = "rgba(94,240,163,0.85)";
        ctx.beginPath();
        ctx.roundRect(-p.size, -p.size, p.size*2, p.size*2, 8);
        ctx.fill();
      }

      ctx.restore();
    }
  }

  // roundRect polyfill for older browsers
  if (!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r,y);
      this.arcTo(x+w,y, x+w,y+h, r);
      this.arcTo(x+w,y+h, x,y+h, r);
      this.arcTo(x,y+h, x,y, r);
      this.arcTo(x,y, x+w,y, r);
      this.closePath();
      return this;
    };
  }

  function drawBase(r, A){
    const Wc = canvas.getBoundingClientRect().width;
    const Hc = canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Sun glow + subtle pulse
    const pulse = 0.5 + 0.5*Math.sin(performance.now()/400);
    ctx.save();
    ctx.globalAlpha = 0.25 + 0.55*r.L;
    ctx.fillStyle = `rgba(255,215,120,${0.18 + 0.22*pulse})`;
    ctx.beginPath(); ctx.arc(A.sun.x, A.sun.y, 46 + 16*r.L + 6*pulse, 0, Math.PI*2); ctx.fill();

    // Rays (animated shimmer)
    ctx.strokeStyle = `rgba(255,215,120,${0.08 + 0.24*r.L})`;
    ctx.lineWidth = 2;
    for (let i=0;i<14;i++){
      const a = i*(Math.PI*2/14) + performance.now()/2200;
      const r1 = 72, r2 = 110 + 36*r.L + 10*pulse;
      ctx.beginPath();
      ctx.moveTo(A.sun.x + Math.cos(a)*r1, A.sun.y + Math.sin(a)*r1);
      ctx.lineTo(A.sun.x + Math.cos(a)*r2, A.sun.y + Math.sin(a)*r2);
      ctx.stroke();
    }
    ctx.restore();

    // Leaf (pulse slightly with rate)
    ctx.save();
    ctx.translate(A.leaf.x, A.leaf.y);
    ctx.rotate(A.leaf.rot);
    const leafPulse = 1 + r.rate*0.02*Math.sin(performance.now()/600);
    ctx.scale(leafPulse, leafPulse);

    ctx.fillStyle = `rgba(120,255,160,${0.07 + 0.14*r.rate})`;
    ctx.strokeStyle = "rgba(200,255,220,0.22)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.ellipse(0,0, A.leaf.w/2, A.leaf.h/2, 0, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();

    // veins
    ctx.strokeStyle = "rgba(200,255,220,0.12)";
    ctx.lineWidth = 1;
    for(let i=-4;i<=4;i++){
      ctx.beginPath();
      ctx.moveTo(-A.leaf.w*0.32, i*18);
      ctx.quadraticCurveTo(0, i*10, A.leaf.w*0.32, i*18);
      ctx.stroke();
    }

    // stomata bar (animated breathing)
    const sBreath = 0.85 + 0.15*Math.sin(performance.now()/700);
    const stomW = 120 * (0.45 + 0.55*r.S) * sBreath;
    ctx.fillStyle = `rgba(122,170,255,${0.10 + 0.35*r.S})`;
    ctx.beginPath();
    ctx.roundRect(-stomW/2, A.leaf.h*0.34, stomW, 10, 999);
    ctx.fill();

    // chloroplast "zones"
    function chloroplast(x,y, strength){
      ctx.save();
      ctx.translate(x,y);
      ctx.globalAlpha = 0.10 + 0.28*strength;
      ctx.fillStyle = "rgba(94,240,163,0.65)";
      ctx.beginPath();
      ctx.ellipse(0,0, 46, 26, 0.4, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha *= 0.8;
      ctx.strokeStyle = "rgba(233,238,252,0.18)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.ellipse(0,0, 38, 20, 0.4, 0, Math.PI*2);
      ctx.stroke();
      ctx.restore();
    }
    chloroplast(-60,-30, r.rate);
    chloroplast( 50, 20, r.rate);

    // "Calvin cycle" center ring (sugar making)
    ctx.save();
    ctx.translate(10,-10);
    ctx.globalAlpha = 0.10 + 0.30*r.rate;
    ctx.strokeStyle = "rgba(255,204,102,0.65)";
    ctx.lineWidth = 2;
    const spin = performance.now()/1200;
    ctx.beginPath();
    ctx.arc(0,0, 34, spin, spin + Math.PI*1.6);
    ctx.stroke();
    ctx.restore();

    ctx.restore(); // leaf

    // Flow arrows (subtle)
    arrow(A.sun.x+120, A.sun.y+60, A.leaf.x-170, A.leaf.y-100, 0.12 + 0.35*r.L);
    arrow(A.co2In.x+40, A.co2In.y, A.leaf.x-190, A.leaf.y+10, 0.12 + 0.30*r.C);
    arrow(A.waterIn.x+20, A.waterIn.y-10, A.leaf.x-165, A.leaf.y+120, 0.12 + 0.30*r.W);
    arrow(A.leaf.x+190, A.leaf.y-10, A.o2Out.x-40, A.o2Out.y, 0.10 + 0.35*r.rate);
    arrow(A.leaf.x+175, A.leaf.y+75, A.sugarOut.x-40, A.sugarOut.y, 0.10 + 0.35*r.rate);

    // Heat / stress glow
    ctx.save();
    ctx.globalAlpha = 0.08 + 0.30*r.stress;
    ctx.fillStyle = "rgba(255,110,110,0.55)";
    ctx.beginPath();
    ctx.ellipse(A.leaf.x, A.leaf.y, 230, 160, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();

    // Text
    ctx.save();
    ctx.fillStyle = "rgba(233,238,252,0.85)";
    ctx.font = "600 14px system-ui";
    ctx.fillText("Light ‚Üí energy (ATP/NADPH) in chloroplasts ‚Üí sugar from CO‚ÇÇ", 18, 28);
    ctx.font = "12px system-ui";
    ctx.fillStyle = "rgba(233,238,252,0.75)";
    ctx.fillText(`Limiting factor: ${r.limiting.k}`, 18, 48);
    ctx.restore();

    // particles on top
    drawParticles();
  }

  // --- UI update (still instant) ---
  function updateUI(r){
    ui.lightVal.textContent = `(${ui.light.value}%)`;
    ui.co2Val.textContent = `(${ui.co2.value}%)`;
    ui.waterVal.textContent = `(${ui.water.value}%)`;
    ui.tempVal.textContent = `(${ui.temp.value}¬∞C)`;
    ui.stomataVal.textContent = `(${ui.stomata.value}%)`;

    ui.rate.textContent = (r.rate*100).toFixed(0) + "%";
    ui.o2.textContent = r.o2.toFixed(1) + " units/min";
    ui.sugar.textContent = r.sugar.toFixed(1) + " units/min";
    ui.loss.textContent = (r.transp*100).toFixed(0) + "%";
    ui.stress.textContent =
      r.stress < 0.25 ? "Low ‚úÖ" :
      r.stress < 0.55 ? "Medium ‚ö†Ô∏è" : "High ‚ùå";

    ui.limit.textContent = r.limiting.k;
    ui.limitExplain.textContent = r.limiting.why;

    ui.lessonText.textContent =
      `Fix the limiting factor first: ${r.limiting.k}. ` +
      `Stomata help CO‚ÇÇ enter but increase water loss (especially in heat).`;

    ui.rateBar.style.width = (r.rate*100).toFixed(0) + "%";
    const col =
      r.stress > 0.65 ? "rgba(255,107,107,0.85)" :
      r.rate > 0.70 ? "rgba(94,240,163,0.85)" :
      "rgba(255,204,102,0.85)";
    ui.rateBar.style.background = col;
  }

  // --- Animation loop + spawning logic ---
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now - last)/1000);
    last = now;

    const r = compute();
    updateUI(r);

    const Wc = canvas.getBoundingClientRect().width;
    const Hc = canvas.getBoundingClientRect().height;
    const A = anchors(Wc,Hc);

    // spawn rates scale with inputs + photosynthesis rate
    // photons
    const photonRate = 18 * r.L;
    if (Math.random() < photonRate * dt){
      const x = A.sun.x + rand(40,90);
      const y = A.sun.y + rand(10,80);
      const tx = A.leaf.x - 140 + rand(-20,20);
      const ty = A.leaf.y - 100 + rand(-20,20);
      const vx = (tx-x) * rand(0.35,0.55);
      const vy = (ty-y) * rand(0.35,0.55);
      spawn("photon", x,y, vx,vy, rand(0.7,1.0), rand(6,10));
    }

    // CO2
    const co2Rate = 10 * r.C * (0.35 + 0.65*r.S);
    if (Math.random() < co2Rate * dt){
      const x = A.co2In.x + rand(-10,25);
      const y = A.co2In.y + rand(-18,18);
      const tx = A.stomata.x + rand(-30,30);
      const ty = A.stomata.y + rand(-18,18);
      spawn("co2", x,y, (tx-x)*rand(0.25,0.40), (ty-y)*rand(0.25,0.40), rand(1.0,1.4), rand(5,7));
    }

    // Water
    const waterRate = 8 * r.W;
    if (Math.random() < waterRate * dt){
      const x = A.waterIn.x + rand(-8,18);
      const y = A.waterIn.y + rand(-12,12);
      const tx = A.leaf.x - 150 + rand(-20,20);
      const ty = A.leaf.y + 110 + rand(-18,18);
      spawn("water", x,y, (tx-x)*rand(0.22,0.36), (ty-y)*rand(0.22,0.36), rand(1.0,1.4), rand(6,9));
    }

    // Energy packets inside leaf (light reactions) ‚Äî scale with LIGHT + overall rate
    const energyRate = 14 * r.rate * r.L;
    if (Math.random() < energyRate * dt){
      const pick = Math.random() < 0.5 ? A.chlA : A.chlB;
      // drift toward calvin center (used to make sugar)
      const x = pick.x + rand(-16,16);
      const y = pick.y + rand(-12,12);
      const tx = A.calvin.x + rand(-16,16);
      const ty = A.calvin.y + rand(-16,16);
      spawn("energy", x,y, (tx-x)*rand(0.25,0.45), (ty-y)*rand(0.25,0.45), rand(0.9,1.3), rand(10,13));
    }

    // Outputs (depend on rate)
    const o2Rate = 10 * r.rate;
    if (Math.random() < o2Rate * dt){
      const x = A.leaf.x + 170 + rand(-10,10);
      const y = A.leaf.y - 10 + rand(-22,22);
      spawn("o2", x,y, rand(40,80), rand(-35,10), rand(1.0,1.6), rand(5,8));
    }

    const sugarRate = 6 * r.rate;
    if (Math.random() < sugarRate * dt){
      const x = A.leaf.x + 155 + rand(-10,10);
      const y = A.leaf.y + 70 + rand(-18,18);
      spawn("sugar", x,y, rand(35,75), rand(-10,20), rand(1.0,1.6), rand(5,8));
    }

    // update particles
    for (let i=P.length-1;i>=0;i--){
      const p = P[i];
      p.life -= dt;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.rot += p.spin * dt;

      // ease velocity down a bit for nicer motion
      p.vx *= (1 - 0.15*dt);
      p.vy *= (1 - 0.15*dt);

      if (p.life <= 0) P.splice(i,1);
    }

    // keep particle count sane
    if (P.length > 420) P.splice(0, P.length - 420);

    // draw base + particles
    drawBase(r, A);

    requestAnimationFrame(loop);
  }

  // interactions: sliders only change state; animation loop keeps running
  ["light","co2","water","temp","stomata"].forEach(id=>{
    ui[id].addEventListener('input', ()=>{});
  });

  // start
  resize();
  setScenario("normal");
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
